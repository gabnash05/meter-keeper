{% extends "base.html" %}
{% block content %}
<h2>Upload Meter Photo</h2>
<div id="upload-container">
    <form id="upload-form" method="post" enctype="multipart/form-data">
        <input type="file" id="file-input" name="file" accept="image/*" capture="environment" required>
        <input type="hidden" id="cropped-image" name="cropped_image">
        <div id="image-cropper" style="display: none;">
            <div id="crop-area"></div>
            <button type="button" id="crop-button">Crop</button>
            <button type="button" id="cancel-crop">Cancel</button>
        </div>
        <button type="submit" id="upload-button" style="display: none;">Upload</button>
    </form>
</div>

<!-- Add Cropper.js CSS and JS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

<style>
    #crop-area {
        max-width: 100%;
        height: 400px;
        margin: 1em 0;
    }
    #image-cropper {
        margin: 1em 0;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('file-input');
    const cropArea = document.getElementById('crop-area');
    const cropButton = document.getElementById('crop-button');
    const cancelCrop = document.getElementById('cancel-crop');
    const uploadButton = document.getElementById('upload-button');
    const croppedImageInput = document.getElementById('cropped-image');
    const imageCropper = document.getElementById('image-cropper');
    
    let cropper;
    
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length === 0) return;
        
        const file = e.target.files[0];
        if (!file.type.match('image.*')) return;
        
        const reader = new FileReader();
        reader.onload = function(event) {
            // Create image element for cropping
            const img = document.createElement('img');
            img.id = 'image-to-crop';
            img.src = event.target.result;
            cropArea.innerHTML = '';
            cropArea.appendChild(img);
            
            // Initialize cropper
            cropper = new Cropper(img, {
                aspectRatio: NaN,
                viewMode: 1,
                autoCropArea: 0.8,
                responsive: true,
                guides: true
            });
            
            // Show cropper controls
            imageCropper.style.display = 'block';
            uploadButton.style.display = 'none';
        };
        reader.readAsDataURL(file);
    });
    
    cropButton.addEventListener('click', function() {
        // Get cropped canvas
        const canvas = cropper.getCroppedCanvas({
            width: 800,  // Set your desired width
            height: 800, // Set your desired height
            minWidth: 256,
            minHeight: 256,
            maxWidth: 4096,
            maxHeight: 4096,
            fillColor: '#fff',
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        });
        
        if (canvas) {
            // Convert canvas to blob
            canvas.toBlob(function(blob) {
                // Create a new File object from the blob
                const file = new File([blob], fileInput.files[0].name, {
                    type: 'image/jpeg',
                    lastModified: Date.now()
                });
                
                // Create a new DataTransfer object to replace the file input
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                fileInput.files = dataTransfer.files;
                
                // Update the preview
                const url = URL.createObjectURL(blob);
                cropArea.innerHTML = `<img src="${url}" style="max-width: 100%;">`;
                
                // Hide cropper controls
                imageCropper.style.display = 'none';
                uploadButton.style.display = 'block';
                
                // Clean up cropper
                cropper.destroy();
            }, 'image/jpeg', 0.9); // 0.9 is the JPEG quality
        }
    });
    
    cancelCrop.addEventListener('click', function() {
        // Reset the file input
        fileInput.value = '';
        cropArea.innerHTML = '';
        imageCropper.style.display = 'none';
        uploadButton.style.display = 'none';
        
        if (cropper) {
            cropper.destroy();
        }
    });
});
</script>
{% endblock %}